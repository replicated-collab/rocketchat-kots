apiVersion: kots.io/v1beta1
kind: HelmChart
metadata:
  name: rocketchat
spec:
  chart:
    name: rocketchat
    chartVersion: 3.3.1-replicated
  values:
    host: "repl{{ LicenseFieldValue `license_url`}}"
    mongodb:
      auth:
        username: rocketchat
        password: "repl{{ ConfigOption `mongo_rocketchat_password`}}"
        database:  rocketchat
        rootPassword: "repl{{ ConfigOption `mongo_root_password`}}"
    license: "repl{{ LicenseFieldValue `rocketchat_enterprise_license`}}"
    registrationToken: "repl{{ LicenseFieldValue `rocketchat_registration_token`}}"
  optionalValues:
    - when: '{{repl ConfigOptionEquals "mongo_type" "external_mongodb"}}'
      values: 
        externalMongodbUrl: "repl{{ ConfigOption `mongo_external_url`}}"
        externalMongodbOplogUrl: "repl{{ ConfigOption `mongo_external_oplog_url`}}"
        mongodb: 
          enabled: false
    - when: '{{repl ConfigOptionEquals "mongo_type" "embedded_mongodb"}}'
      values: 
        mongodb:
          auth:
            username: rocketchat
            password: "repl{{ ConfigOption `mongo_rocketchat_password`}}"
            database:  rocketchat
            rootPassword: "repl{{ ConfigOption `mongo_root_password`}}"
    - when: '{{repl ConfigOptionEquals "use_ingress" "1"}}'
      values: 
        ingress: 
          enabled: true
    - when: '{{repl and (ConfigOptionEquals "use_tls" "1") (not IsKurl) }}'
      values: 
        ingress: 
          enabled: true
          tls: 
            - secretName: rocketchat-tls
              hosts:
                - "repl{{ LicenseFieldValue `license_url`}}"
    # kURL setups have a kotsadm-tls secret, cf.; 
    # https://kots.io/vendor/packaging/using-tls-certs/
    - when: '{{repl and (ConfigOptionEquals "use_tls" "1") (IsKurl) }}'
      values: 
        ingress: 
          enabled: true
          tls: 
            - secretName: kotsadm-tls
              hosts:
                - "repl{{ LicenseFieldValue `license_url`}}" 

  useHelmInstall: true
